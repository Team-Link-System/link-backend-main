config:
  target: "http://localhost:8080"
  phases:
    - duration: 60
      arrivalRate: 10
  processor: "../artillery.js"

scenarios:
  - flow:
      # 회원가입
      - function: "getTimestamp"
      - post:
          url: "/api/user/signup"
          json:
            email: "testuser{{ timestampValue }}{{$randomNumber(1,9999)}}@example.com"
            name: "testuser{{ timestampValue }}{{$randomNumber(1,9999) }}"
            password: "password123"
            nickname: "testuser{{ timestampValue }}{{$randomNumber(1,9999) }}"
            phone: "010-1234-5678"
          capture:
            - json: "$.payload.email"
              as: "userEmail"
          expect:
            - statusCode: 201
      - think: 1

      # 로그인
      - post:
          url: "/api/auth/signin"
          json:
            email: "{{ userEmail }}" # 회원가입에서 저장한 이메일 사용
            password: "password123"
          capture:
            - json: "$.payload.id"            # 로그인 응답 본문에서 사용자 ID 추출
              as: "userId"
            # - header: "Authorization" # 로그인 응답 헤더에서 토큰 추출
            #   as: "accessToken"
          expect:
            - statusCode: 200
      - function: "extractAccessToken"
      - think: 1
      # 프로필 조회
      - get:
          url: "/api/user/{{ userId }}"  # 로그인에서 저장한 ID 사용
          headers:
            Authorization: "{{ accessToken }}" # 토큰 사용
          expect:
            - statusCode: 200
      - think: 1
